<!DOCTYPE html>
<html>
    <head>
        <title>Test IDE integration</title>
        <meta charset="utf-8">
        <style>
            body {
				margin: 0px;
				overflow: hidden;
			}
        </style>
        <script src="js-libs/jszip.min.js"></script>
    </head>
<body>
    <div>
        <div class="column">
            <iframe id="ide" src="onlineIDE/api/load.html?mountPoint=[EmbeddedMontiArc]/demonstrator/IDE" height="900" scrolling="no" width="900" align="left"></iframe>
        </div>
        <div id="rightSide1" class="column">
                <div class="row">
                    <iframe id="indexSimulator" src="index.html"  height="600" width="686" frameborder="0"></iframe>        
                </div>
                <div class="row">
                    <iframe id="trajectoryComparator" src="trajectoryComparatorMain.html" height="300" frameborder="0" width="686"></iframe>
                </div>
        </div>
        <div id="rightSide2" class="column" style="display: none">
            <!-- Change the way of defining the current tutorial link -->
            <iframe id="tutorialFrame" src="tutorials/html/tutorial00.md.html" height="900" width="686" frameborder="0"></iframe>        
        </div>
    </div>
    <div>
        <!-- <button onclick="appendTestModel()">Append test file</button> -->
        <button onclick="appendTestTutorial3()">Add parking tutorial files</button>
        <!-- <button onclick="appendTestTutorial4()">Append tutorial 4</button> -->
        <!-- <button onclick="showContent()">Show Content</button> -->
        <button onclick="readAllFiles()">Read, pack and send files</button>
        <!-- <button onclick="packData()">Pack and Send</button> -->
        <button onclick="showTutorial()">Show tutorial/simulator</button>
        <div style="width:200px;">
            <select id="tutorialSelect" onchange="showSelectedTutorial()">
              <option value="0">Tutorial0</option>
              <option value="1">Tutorial1</option>
              <option value="2">Tutorial2</option>
              <option value="3">Tutorial3</option>
              <option value="4">Tutorial4</option>
            </select>
        </div>
    </div>

    <script>

        function showSelectedTutorial(){

            var tutorialList = document.getElementById("tutorialSelect");
            var selectedTutorial = tutorialList.options[tutorialList.selectedIndex].value;
            console.log(selectedTutorial);
            
            // The list of tutorials
            var tutorialPath = "tutorials/html/tutorial";
            var tutorialExtension = ".md.html";
            var link = ["00","01","02","03","04"];

            document.getElementById('tutorialFrame').src = tutorialPath + link[selectedTutorial] + tutorialExtension;
        }

        function showTutorial(){

            if(document.getElementById("rightSide2").style.display == 'none'){
                document.getElementById("rightSide1").style.display = 'none';
				document.getElementById("rightSide2").style.display = 'block';
            }else {
                document.getElementById("rightSide1").style.display = 'block';
				document.getElementById("rightSide2").style.display = 'none';
            }
		}

        function loadMainController(){

            // if(document.getElementById("indexSimulator").contentWindow.document.getElementById('mainController')){
            //     var elements = document.getElementById("indexSimulator").contentWindow.document.getElementById('mainController');
            //     while (elements[0]) elements[0].parentNode.removeChild(elements[0]);
            // }

            return new Promise((resolve, reject) => {
                var doc = document.getElementById("indexSimulator").contentWindow.document;
                var script_tag = doc.createElement('script');
                script_tag.id = "mainController";
                script_tag.text = rawFileData[0];
                doc.body.appendChild(script_tag);

                setTimeout(()=>{
                    resolve();
                },1000)
            });

        }        

        function overrideReadBinaryWasm(){

            var doc1 = document.getElementById("indexSimulator").contentWindow.document;
            var script_tag1 = doc1.createElement('script');
            script_tag1.id = "mainControllerWasm";
            script_tag1.text = "var Module = {readBinary : function readBinary(filename) {return new Uint8Array(rawWebAssembly);}}";
            doc1.body.appendChild(script_tag1);
        }

        function loadWasmData(){

            document.getElementById("indexSimulator").contentWindow.rawWebAssembly = rawFileData[1];
            
            setTimeout(function(){
                overrideReadBinaryWasm();
            },0);
            
            setTimeout(function(){
                loadMainController().then(
                    document.getElementById("indexSimulator").contentWindow.initSimulator, 
                    ()=>{console.error("error during loading a main controller tag!")});
            },100);
        }

        // TODO: rename and better organize
        function checkWasm(){

            if (checkWasmBinaryData(rawFileData[1])) loadWasmData();
        }

        function appendFile(dirName,fileName,fileContent){
            document.getElementById("ide").contentWindow.api.
                fs.mkdir(dirName,function (err, data) {
                    if (err) throw err;
                });
            document.getElementById("ide").contentWindow.api.
                fs.appendFile(fileName,fileContent,function (err, data) {
                    if (err) throw err;
                });
        }

        function readFileFromDisk(file) {
            var rawFile = new XMLHttpRequest();
            var text;
            rawFile.open("GET", file, false);
            rawFile.onreadystatechange = function () {
                if (rawFile.readyState === 4) {
                    if (rawFile.status === 200 || rawFile.status == 0) {
                        text = rawFile.responseText;
                    }
                }
            }
            rawFile.send(null);
            return text;
        }
        
        // Test function to don't create every time controller's file to test the system 
        // function appendTestModel(){
        //     appendFile("MainController.emam", readFileFromDisk("simulator1/MainController.emam"));
        //     appendFile("ConstantVelocity.emam", readFileFromDisk("simulator1/ConstantVelocity.emam"));
        //     appendFile("SteeringControl.emam", readFileFromDisk("simulator1/SteeringControl.emam"));
        //     appendFile("GameOverTrigger.emam", readFileFromDisk("simulator1/GameOverTrigger.emam"));
        // }

        function appendTestTutorial3(){
            appendFile("/controller03","controller03/MainController.emam", readFileFromDisk("tutorials/controllers/controller03/MainController.emam"));
            appendFile("/controller03","controller03/ParkingController.emam", readFileFromDisk("tutorials/controllers/controller03/ParkingController.emam"));
            appendFile("/controller03","controller03/SearchParkingPlaceController.emam", readFileFromDisk("tutorials/controllers/controller03/SearchParkingPlaceController.emam"));
            appendFile("/controller03","controller03/VelocityController.emam", readFileFromDisk("tutorials/controllers/controller03/VelocityController.emam"));

            document.getElementById("indexSimulator").contentWindow.presentationObjects = 3;
        }

        function appendTestTutorial4(){
            appendFile("/controller04","controller04/MainController.emam", readFileFromDisk("tutorials/controllers/controller04/MainController.emam"));
            appendFile("/controller04","controller04/ConeRunner.emam", readFileFromDisk("tutorials/controllers/controller04/ConeRunner.emam"));
            appendFile("/controller04","controller04/VelocityController.emam", readFileFromDisk("tutorials/controllers/controller04/VelocityController.emam"));

            document.getElementById("indexSimulator").contentWindow.presentationObjects = 4;
        }

        // Read files from ide and pack

        var filesData = Array();
        var fileNames = Array();

        function readFileName(name) {
            
            document.getElementById("ide").contentWindow.api.fs.readFile('/' + name, function (err, data) {
                if (err) throw err;
                filesData.push(data);
                fileNames.push(name);
            });
        }

        var firstTimeRunAlert = false;
        // traverse the folder(project name) 
        function readAllFiles() {

            if(!firstTimeRunAlert){
                alert("There is an security issue with the connection to the server RWTH-Aachen. It does not have HTTPS certificate yet. To be able to send the data to the server, please allow executing the insecure content. \n In the Chrome browser, the small shield is appeared in the upper right conner, just click on in and then click on - Load unsafe scripts. Then, try please send again. \n We are really sorry for inconvenience. Thank you for your understanding.");
                firstTimeRunAlert = true;
            }

            document.getElementById("indexSimulator").contentWindow.notReadyToGo();

            filesData = [];
            fileNames = [];
            var dirRoot = '/';
            var folderName;
            
            var apiFs = document.getElementById("ide").contentWindow.api.fs;
            
            apiFs.readdir(dirRoot,function (err, dir){
                
                if (err) throw err;
                dir.forEach( function (item){
                    // The folder(item) has to be a root directory for a model
                    if(item.mime == "folder" && !(item.name).includes(".")){

                        folderName = item.name;
                        apiFs.readdir(dirRoot+item.name, function (err, dirInternal){
                
                            if (err) throw err;
                            dirInternal.forEach( function (file){
             
                                if((file.name).includes(".emam") || (file.name).includes(".stream")){
                                    readFileName(item.name + "/" +file.name);
                                }
                            });
                        });
                        
                    }
                });
            });

            setTimeout(function(){
                packData(folderName).then(sendData,function(){
                    console.log("packing problem happened!");
                });
            },100);
        }

        // show the content which was red from IDE
        function showContent(){

            fileNames.forEach(function(item,index){
                console.log(item);
                console.log(filesData[index]);
            });
        }

        var zipContainer = new JSZip();

        function packData(folderName){
            return new Promise((resolve, reject) => {
                fileNames.forEach(function(item,index){
                    zipContainer.file(item, filesData[index]);
                    console.log(item," was packed!");
                });
                setTimeout(()=>{
                    resolve();
                },0)
            });
        }

        function sendData(){
            var t0 = performance.now();
            zipContainer.generateAsync({type:"blob"}).then(function (content) {
                
                var blob1 = new Blob([content], {type: 'application/octet-binary'});
                var xhr = new XMLHttpRequest();
                xhr.open("POST", 'http://137.226.168.11:80/receiver/', true);
                //xhr.open("POST", 'http://0.0.0.0:7070/receiver/', true);
                xhr.send(blob1);
                console.log("files were sent to the server, waiting for responce...");
                // TODO: why the server does not set response type?
                xhr.responseType = "blob";
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status == 200){
                            var t1 = performance.now();
                            // Write to the console a compilation time
                            console.log("Compilation time: " + ((t1 - t0)/1000) + " seconds.");
                            saveFileFromResponse(xhr.response);    
                        }
                        if (xhr.status == 500){
                            
                            console.log(xhr.status);
                            console.log(xhr.statusText);
                        }
                    }
                }
            });
        }

        // TODO: save file from variable to VFS

        var rawFileData = new Array();

        function saveFileFromResponse(receivedDataFromServer){

            // delete files from previous compilation
            while (rawFileData.length) 
					{   
                        console.log("clean previous data from server!");
						rawFileData.pop(); 
					}

            var new_zip = new JSZip();

            new_zip.loadAsync(receivedDataFromServer).then(function (zip) {
                Object.keys(zip.files).forEach(function (filename) {
                    if(filename.includes("wasm")){
                        zip.files[filename].async('uint8array').then(function (fileData) {
                        console.log(filename);
                        //appendFile(".home/" + filename, fileData);
                        rawFileData.push(fileData);
                    });}
                    else{
                    zip.files[filename].async('string').then(function (fileData) {
                        console.log(filename);
                        //appendFile(".home/" + filename, fileData);
                        rawFileData.push(fileData);
                    });
                    }
                });
            });
            
            // wait for async unpack
            setTimeout(function(){
                checkWasm();
            }, 500);
        }

        function checkWasmBinaryData(data){
                
            var valid = false;
            
            if (data != undefined){
                valid = WebAssembly.validate(data);
                console.log("The given bytes are "
                    + (valid ? "" : "not ") + "a valid wasm module"); 
            }
            return valid;            
        }

        function showLogs(flag){
            document.getElementById("indexSimulator").contentWindow.showLogsData = flag;
            return "set " + flag;
        }

        function getSimulationLog(){
            var simulationLog = document.getElementById("indexSimulator").contentWindow.logObject;
            document.getElementById("trajectoryComparator").contentWindow.fillSimulationData(simulationLog);
        }

        function reloadTrajectoryPage(){
            console.log("reload!");
            document.getElementById('trajectoryComparator').contentWindow.location.reload();
        }
        
    </script>
</body>
</html>